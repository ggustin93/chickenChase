# Récapitulatif des Fonctionnalités et Flux de Données par Rôle

## 1. Tableau Récapitulatif des Fonctionnalités par Rôle

| Rôle              | Fonctionnalité Principale Clé                                  | Description Courte / Objectif                                                                                                | Référence PRD (Core Feature) |
|-------------------|--------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------|------------------------------|
| **Admin / Organisateur** | Création et Configuration de Partie                        | Définir zone, cagnotte, équipes, défis initiaux, générer code de partie.                                                     | 1                            |
|                   | Gestion du Lancement                                         | Le système attribue aléatoirement le rôle "Poulet".                                                                          | 1                            |
| **Poulet (Chicken)**  | Rejoindre une Partie                                         | S'authentifier et utiliser un code pour entrer dans la session de jeu.                                                       | 2, UX Flows                  |
|                   | Sélection du Bar Initial                                     | Choisir et confirmer le bar où se cacher.                                                                                    | 2                            |
|                   | Validation des Soumissions                                   | Approuver/refuser les défis soumis et les visites de bar avec photo.                                                         | 2                            |
|                   | Communication (Indices)                                      | Envoyer des indices ou messages à toutes les équipes.                                                                        | 2, 4                         |
|                   | Enregistrement des Dépenses de la Cagnotte                   | Noter les dépenses de la cagnotte commune (ex: tournées offertes).                                                           | 2                            |
|                   | Confirmation des Trouvailles                                 | Marquer manuellement quand une équipe Chasseur a trouvé le Poulet.                                                           | 2, 5                         |
|                   | Ajout de Défis Personnalisés                                 | Créer et ajouter de nouveaux défis en cours de partie.                                                                       | 2                            |
| **Chasseur (Hunter)** | Rejoindre une Partie                                         | S'authentifier et utiliser un code pour entrer dans la session de jeu.                                                       | 3, UX Flows                  |
|                   | Consultation Carte & Liste des Bars                          | Visualiser la zone de jeu, les bars disponibles et visités.                                                                  | 3                            |
|                   | Marquage des Visites de Bar                                  | Enregistrer une visite (validation GPS ou soumission photo si échec GPS).                                                      | 3                            |
|                   | Réalisation et Soumission de Défis                           | Consulter les défis, capturer et envoyer les preuves (photos).                                                              | 3                            |
|                   | Communication (Équipe & Globale)                             | Discuter avec son équipe et consulter les messages globaux/indices.                                                          | 3, 4                         |
|                   | Consultation Score & Classement                              | Suivre son score et la position des équipes.                                                                                 | 3, 5                         |
| **Tous les Rôles**| Authentification                                             | Se connecter à l'application (Magic Link).                                                                                   | UX Flows                     |
|                   | Accès aux Règles du Jeu                                      | Consulter les règles (via `Rules.tsx`).                                                                                      | -                            |
|                   | Visualisation du Classement                                  | Voir le classement général des équipes.                                                                                      | 5                            |
|                   | Participation au Chat Global                                 | Échanger des messages avec tous les participants.                                                                            | 4                            |

## 2. Tableau Récapitulatif des Flux de Données Clés par Rôle/Action

| Rôle / Action Clé                                | Flux de Données Simplifié (Composants/Services Impliqués)                                                                                                                                                                                                                            |
|--------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Admin: Créer une Partie**                      | PWA (Formulaire `AdminPage.tsx`) -> Supabase DB (Création `games` record avec settings, `cagnotte_initiale`, etc.) -> Supabase Function (`generate_game_code` - implicite) -> PWA (Affichage code)                                                                                   |
| **Admin: Lancement (Assignation Poulet)**        | PWA (Action de lancement) -> Supabase Function (`assign_chicken_role` sur `game_id`) -> Supabase DB (Mise à jour `games.chicken_team_id`, `participants.role`) -> Supabase Realtime (Notification aux joueurs de leur rôle)                                                         |
| **Joueur (Poulet/Chasseur): Authentification**     | PWA (`Home.tsx`) -> Supabase Auth (`signInWithOtp` - Magic Link) -> Email Service -> Utilisateur (clic lien) -> PWA (Capture session) -> Supabase Auth (Vérification) -> PWA (Stockage session, récupération profil `users`)                                                         |
| **Joueur (Poulet/Chasseur): Rejoindre Partie**     | PWA (Input code) -> Supabase DB (Vérification `games.code`, création `participants` record, assignation `team_id`) -> PWA (Redirection vers interface de rôle)                                                                                                                          |
| **Poulet: Sélectionner Bar Initial**             | PWA (`ChickenPage.tsx` - `MapTabContent`) -> Supabase DB (Mise à jour `games.chicken_selected_bar_id` ou similar)                                                                                                                                                                      |
| **Poulet: Valider Défi (avec photo)**            | PWA (`ChickenPage.tsx` - `ChallengesTabContent`) -> Supabase DB (Mise à jour `challenges.status = 'approved'/'rejected'`, `challenges.validated_at`) -> Supabase Function (`update_score`) -> Supabase DB (Mise à jour `teams.score`) -> Supabase Realtime (Notification Chasseur, MàJ classement) |
| **Poulet: Confirmer Équipe Trouvée**             | PWA (`ChickenPage.tsx` - `TeamsTabContent` ou `LeaderboardTab`) -> Supabase DB (Mise à jour `teams.found_chicken_at`, `teams.found_order` pour `team_id` spécifique) -> Supabase Function (`update_score`) -> Supabase Realtime (MàJ classement, potentielle fin de partie)             |
| **Poulet: Enregistrer Dépense Cagnotte**         | PWA (Interface dédiée Poulet) -> Supabase DB (Mise à jour `games.cagnotte_remaining`) -> Supabase Realtime (Notification de la dépense dans le Newsfeed)                                                                                                                                |
| **Poulet: Ajouter Défi Personnalisé**            | PWA (Formulaire `ChickenPage.tsx`) -> Supabase DB (Création `challenges` record avec `custom_title`, `custom_description`, `custom_points`, `game_id`, `team_id=NULL` ou `chicken_team_id`) -> Supabase Realtime (Notification aux Chasseurs du nouveau défi)                        |
| **Chasseur: Marquer Visite Bar (Photo)**         | PWA (`PlayerPage.tsx` - `MapTab`) -> Capacitor Camera (Prise photo) -> Supabase Storage (Upload `validation_photo_url`) -> Supabase DB (Création `visits` record avec `status='pending_photo_validation'`, `validation_photo_url`) -> Supabase Realtime (Notification Poulet)     |
| **Chasseur: Soumettre Preuve Défi (Photo)**      | PWA (`PlayerPage.tsx` - `ChallengesTab`) -> Capacitor Camera (Prise photo) -> Supabase Storage (Upload `proof_photo_url`) -> Supabase DB (Mise à jour `challenges` record avec `status='pending_validation'`, `proof_photo_url`, `submitted_at`) -> Supabase Realtime (Notification Poulet) |
| **Tous: Envoyer Message Chat Global**            | PWA (Interface Chat) -> Supabase DB (Création `messages` record avec `content`, `user_id`, `game_id`) -> Supabase Realtime (Diffusion message à tous les participants du `game_id`)                                                                                                       |
| **Tous: Récupérer Défis Initiaux**               | PWA (Au chargement de la partie) -> PageCMS API (Fetch liste défis) -> PWA (Stockage/Affichage)                                                                                                                                                                                         |

**Note:** Les flux de données sont simplifiés. Des étapes intermédiaires (ex: compression d'image client avant upload vers Supabase Storage) ou des vérifications de permissions (RLS) sont implicites. Les notifications Push sont prévues pour Phase 2. 